# Simple workflow for deploying static content to GitHub Pages
name: Deploy API to server
on:
  # Runs on pushes targeting the default branch
  push:
    branches: 
      - master

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy_to_QA:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: master
      - name: Generate .env File
        run: |
          echo "LOCAL_SERVER=${{ secrets.QA_SOLR }}" >> api.env
          echo "SOLR_USER=${{ secrets.QA_USERNAME_SOLR }}" >> api.env
          echo "SOLR_PASS=${{ secrets.QA_PASSWORD_SOLR }}" >> api.env
          
      - name: Fast FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.QA_FTP_HOST }}
          username: ${{ secrets.QA_FTP_USER }}
          password: ${{ secrets.QA_FTP_PASSWD }}
          local-dir: ./
          server-dir: /htdocs/api/

  deploy_to_PROD:
    needs: deploy_to_QA
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: master
      - name: Generate .env File
        run: |
          echo "PROD_SERVER=${{ secrets.PROD_SERVER }}" >> api.env
          echo "BACK_SERVER=${{ secrets.BACK_SERVER }}" >> api.env
          echo "SOLR_USER=${{ secrets.USERNAME_SOLR }}" >> api.env
          echo "SOLR_PASS=${{ secrets.PASSWORD_SOLR }}" >> api.env
          
      - name: Fast FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWD }}
          local-dir: ./
          server-dir: /api.peviitor.ro/
